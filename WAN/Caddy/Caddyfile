import /app/configs/Snippets/GlobalConfig
import /app/configs/Snippets/References

# Root domain - domain.tld
{$FQDN} {
   import tls
   import header_csp https://blog.{$FQDN}
   import coraza
   crowdsec
   respond "Reworking internal things, we'll be back fairly soon! twitch.tv/og_mrrubberducky if you wanna talk." 200
}

# Wildcard certificate - *.domain.tld
*.{$FQDN} {
   # Request wildcard certificate via DNS-01
   import tls

   # =========================
   # Domain block
   # =========================
   @blog host blog.{$FQDN}
   @umami host analytics.{$FQDN}
   @comments host comments.{$FQDN}
   @auth host auth.{$FQDN}
   @uptime host uptime.{$FQDN}
   @miniflux host news.{$FQDN}

   # =========================
   # Site block
   # =========================

   # Blog
   handle @blog {
      crowdsec
      redir https://rubberverse.xyz 302
   }

   # Analytics
   handle @umami {
      route /api* {
         import websockets localhost:9001
      }
      import header_csp https://analytics.{$FQDN}
      crowdsec
      import proxy localhost:9001
   }

   # Commentario
   handle @comments {
      import header_csp https://comments.{$FQDN}
      crowdsec
      import proxy localhost:9002
   }

   # Pocket-ID
   # Coraza breaks NextJS applications due to response buffering so we aren't using it for umami nor Pocket-ID
   handle @auth {
      import header_csp https://auth.{$FQDN}
      crowdsec
      import proxy localhost:9003
   }

   # Gatus
   # Doesn't seem to care about Coraza much.
   handle @uptime {
     import header_csp https://uptime.{$FQDN}
     import coraza
     crowdsec
     import proxy localhost:9004
   }

   # Miniflux
   # Coraza adds slight delay to rendering but it's liveable
   handle @miniflux {
     import header_csp https://news.{$FQDN}
     import coraza
     crowdsec
     import proxy localhost:9005
   }
}
